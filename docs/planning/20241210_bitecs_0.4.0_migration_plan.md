# bitECS 0.4.0 Migration - Implementation Plan

**Created:** 2025-12-10  
**Approach:** Big-Bang Migration (all changes at once)  
**Component Format:** Regular Arrays (`number[]`)

---

## User Decisions
- ✅ **Regular Arrays** for component data (simpler, no pre-allocation needed)
- ✅ **Big-Bang Migration** (all at once, no legacy module phasing)

---

## Summary of Changes

| Category | Count | Description |
|----------|-------|-------------|
| Components | 23 | `defineComponent()` → plain objects |
| Queries | 25+ | `defineQuery()` → `query()` function |
| Observers | 4 | `enterQuery`/`exitQuery` → `observe()` |
| addComponent | ~200 | Parameter order swap |
| removeComponent | 24 | Parameter order swap |

---

## Coding Agent Task Definitions

### Task A: Update Package
- **File:** `package.json`
- **Change:** `"bitecs": "~0.3.40"` → `"bitecs": "^0.4.0"`
- **Run:** `npm install`

---

### Task B: Migrate Components  
- **File:** `src/ecs/components.ts`
- **Change:** Convert 23 `defineComponent()` to plain objects

```typescript
// Before
import { defineComponent, Types } from 'bitecs';
export const Position = defineComponent({ x: Types.f32, y: Types.f32 });

// After  
export const Position = { x: [] as number[], y: [] as number[] };
```

---

### Task C: Migrate Queries (Systems)
- **Files:** 14 system files in `src/systems/`
- **Change:** `defineQuery([...])` → `query(world, [...])`

```typescript
// Before
const movementQuery = defineQuery([Position, Velocity]);
const entities = movementQuery(world);

// After
const entities = query(world, [Position, Velocity]);
```

---

### Task D: Migrate Queries (Rendering/Game/Core)
- **Files:** 9 files across `src/rendering/`, `src/game/`, `src/core/`
- **Change:** Same pattern as Task C

---

### Task E: Migrate renderSystem.ts Observers
- **File:** `src/systems/renderSystem.ts`
- **Change:** Replace `enterQuery`/`exitQuery` with `observe()` pattern

```typescript
// Before
const renderEnterQuery = enterQuery(renderQuery);
const entered = renderEnterQuery(world);

// After
const enteredQueue: number[] = [];
observe(world, onAdd(Position, Faction, SpriteRef), (eid) => enteredQueue.push(eid));
const entered = enteredQueue.splice(0);
```

> [!WARNING]
> Requires restructuring `createRenderSystem` to accept `world` parameter for observer setup.

---

### Task F: Migrate addComponent (Factories)
- **Files:** `src/ecs/entityFactory.ts`, `src/ecs/genericFactory.ts`
- **Change:** `addComponent(world, Component, eid)` → `addComponent(world, eid, Component)`

---

### Task G: Migrate addComponent (Game Logic)
- **Files:** `src/game/waveManager.ts`
- **Change:** Same pattern as Task F

---

### Task H: Migrate add/removeComponent (Systems + Pool)
- **Files:** `src/systems/statusEffectSystem.ts`, `src/ecs/PoolManager.ts`
- **Change:** Both addComponent and removeComponent parameter order

---

### Task I: Migrate Test Files (Batch 1)
- **Files:** First 25 test files in `src/__tests__/`
- **Change:** addComponent parameter order

---

### Task J: Migrate Test Files (Batch 2)  
- **Files:** Remaining ~24 test files
- **Change:** addComponent parameter order

---

### Task K: Final Verification
- **Commands:**
  ```bash
  npm run lint
  npm test
  npm run build
  npm run dev  # Manual check
  ```

---

## Execution Order

```
A (Package) → B (Components) → C,D (Queries) → E (Observers)
    → F (Factory addComponent) → G (Game addComponent)
    → H (System add/remove) → I,J (Tests) → K (Verify)
```

---

## Verification Plan

### Automated
| Command | Purpose |
|---------|---------|
| `npm run lint` | ESLint validation |
| `npm test` | 49 Vitest test files |
| `npm run build` | TypeScript + Vite build |

### Manual
1. Run `npm run dev`
2. Verify game loads without errors
3. Start Wave 1, confirm enemies spawn and turrets fire
4. Verify entity cleanup on death

---

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| Observer timing issues | Thorough testing of sprite lifecycle in renderSystem |
| Parameter order bugs | Tasks split by file type for focused changes |
| Test failures | Tests updated last, after all implementation changes |
